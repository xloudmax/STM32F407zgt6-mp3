STM32 音频播放器系统设计与实现

---

#### **实验目的**
1. 掌握基于 STM32F407 嵌入式开发的硬件驱动设计与软件编程技术。
2. 熟悉外设（如 LCD、按键、SD 卡、音频芯片等）的硬件驱动和软件控制。
3. 设计并实现一个支持 WAV 格式音频文件的嵌入式播放器。
4. 应用 FAT 文件系统，实现对外部存储设备的音频文件管理。
5. 学习并实现音频解码芯片 WM8978 的配置和音频输出。

---

#### **实验背景**
在嵌入式系统设计中，音频处理和播放是一项常见任务。通过 STM32F407 微控制器的强大外设能力（如 SPI、I2C、I2S 等），可以实现复杂的音频播放功能。本实验通过集成 FAT 文件系统、LCD、按键输入和音频解码芯片（WM8978），完成一个嵌入式音频播放器的设计与实现。

---

#### **实验设备**
1. STM32F407 开发板
2. 外接 SD 卡存储模块
3. 2.4 英寸 LCD 屏
4. 音频芯片 WM8978
5. 耳机或扬声器
6. 调试工具（串口调试助手）

---

#### **项目结构**

##### **1. 主程序模块**
- **功能**：负责初始化硬件、调度音频播放逻辑。
- **主要文件**：
  - `main.c`：项目主入口，包含所有外设初始化和音频播放逻辑。

##### **2. 硬件驱动模块**
- **功能**：实现外设（如 LCD、按键、LED、SPI、I2C 等）的基本功能。
- **主要文件**：
  - `lcd.c`：LCD 显示驱动，用于显示播放状态、时间等。
  - `key.c`：按键驱动，实现交互功能（如暂停、上一曲、下一曲）。
  - `led.c`：LED 控制，用于系统状态指示。
  - `spi.c`：SPI 驱动，负责与外部存储设备通信。
  - `i2s.c`：I2S 驱动，传输音频数据至音频芯片。

##### **3. 音频模块**
- **功能**：解析 WAV 文件、管理播放逻辑、控制音量及 EQ（均衡器）。
- **主要文件**：
  - `audioplay.c`：音频播放控制，包括文件选择、索引管理、时间进度显示等。
  - `wm8978.c`：音频芯片 WM8978 的驱动，负责初始化和配置 DAC 输出。
  - `wavplay.c`：解析 WAV 文件格式，并通过 I2S 输出音频数据。

##### **4. 文件系统模块**
- **功能**：提供文件读取、音频文件列表管理等功能。
- **主要文件**：
  - `ff.c`：FAT 文件系统核心库。
  - `diskio.c`：磁盘接口驱动。
  - `exfuns.c`：扩展功能，支持 WAV 文件格式识别。

##### **5. 显示与交互模块**
- **功能**：通过 LCD 显示音量、播放时间、当前曲目索引等信息。
- **主要文件**：
  - `text.c`：提供文本和图形显示功能。
  - `encoder.c`：处理编码器输入，实现音量调节。

---

#### **系统工作流程**

1. **硬件初始化**
   - 调用初始化函数对硬件外设（如串口、LCD、按键、WM8978、I2S 等）进行配置。
   - 加载 FAT 文件系统，挂载 SD 卡并检查文件系统状态。

2. **音频文件扫描**
   - 打开 SD 卡中的音乐文件夹 `/MUSIC`。
   - 遍历目录，筛选有效的 WAV 文件，并记录文件路径和索引。

3. **音频播放**
   - 通过按键选择需要播放的音频文件。
   - 调用 `wav_play_song()` 函数解析 WAV 文件，通过 I2S 输出到 WM8978，完成音频播放。

4. **播放控制**
   - 使用按键切换上一曲/下一曲，或暂停播放。
   - 通过 LCD 显示当前曲目名称、索引、播放时间、总时间及音量。

5. **交互显示**
   - 音量通过编码器调整，并实时更新到 LCD 上。
   - 显示当前播放的音频信息，包括 EQ 设置、比特率等。

---

#### **核心代码说明**

##### **1. 音频播放逻辑**

```c
void audio_play(void)
{
    // 初始化音频解码芯片
    WM8978_ADDA_Cfg(1, 0); // 启用 DAC
    WM8978_Input_Cfg(0, 0, 0); // 禁用所有输入
    WM8978_Output_Cfg(1, 0); // 启用输出

    // 打开音频文件目录
    while (f_opendir(&wavdir, "0:/MUSIC"))
    {
        Show_Str(30, 240, 240, 16, "打开MUSIC文件夹错误!", 16, 0);
    }

    // 遍历音乐文件并播放
    while (curindex < totwavnum)
    {
        dir_sdi(&wavdir, wavindextbl[curindex]);
        res = f_readdir(&wavdir, &wavfileinfo);
        if (res != FR_OK || wavfileinfo.fname[0] == 0) break;

        strcpy((char *)pname, "0:/MUSIC/");
        strcat((char *)pname, (const char *)fn);

        // 调用播放函数
        key = audio_play_song(pname);
        if (key == KEY2_PRES) curindex--; // 上一曲
        else if (key == KEY0_PRES) curindex++; // 下一曲
    }
}
```

##### **2. 音量调节逻辑**

```c
void WM8978_HPvol_Set(u8 voll, u8 volr)
{
    voll &= 0X3F;
    volr &= 0X3F;
    if (voll == 0) voll |= 1 << 6; // 静音
    if (volr == 0) volr |= 1 << 6;
    WM8978_Write_Reg(52, voll); // 设置左声道音量
    WM8978_Write_Reg(53, volr | (1 << 8)); // 设置右声道音量
}
```

##### **3. 音频文件扫描**

```c
u16 audio_get_tnum(u8 *path)
{
    u16 rval = 0;
    DIR tdir;
    FILINFO tfileinfo;
    res = f_opendir(&tdir, (const TCHAR *)path);
    while (res == FR_OK)
    {
        res = f_readdir(&tdir, &tfileinfo);
        if (res != FR_OK || tfileinfo.fname[0] == 0) break;
        fn = (u8 *)(*tfileinfo.lfname ? tfileinfo.lfname : tfileinfo.fname);
        if (f_typetell(fn) & 0xF0 == 0x40) rval++;
    }
    return rval;
}
```

---

#### **实验结果**

1. **功能实现**
   - 成功播放 WAV 格式音频文件，音质清晰，无卡顿。
   - 支持音量调节、上一曲、下一曲操作。
   - LCD 屏显示播放状态、时间、音量和当前曲目名称。

2. **性能表现**
   - 文件系统操作快速，能稳定读取音频文件。
   - 音频播放过程中系统响应迅速。

3. **可视化效果**
   - 音量进度条和播放进度条实时刷新，直观显示播放状态。

---

#### **实验总结**

通过本实验，熟悉了 STM32 硬件开发的完整流程，掌握了 I2S 音频传输协议和 WM8978 音频芯片的配置方法。通过集成 FAT 文件系统，实现了音频文件管理功能。本次实验的设计具备实用性，并可以扩展为更复杂的嵌入式音频系统。

##### **改进方向**
1. 增加 MP3 文件支持。
2. 优化按键响应逻辑，增强用户体验。
3. 增加播放列表和随机播放功能。

---
